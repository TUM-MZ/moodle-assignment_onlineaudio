define(["jquery"],function(a){var b={init:function(){var c="./vendor/recorderWorker.js",d=new Worker("./vendor/mp3Worker.js"),e=function(b,e){function f(a){for(var b="",c=new Uint8Array(a),d=c.byteLength,e=0;d>e;e++)b+=String.fromCharCode(c[e]);return window.btoa(b)}function g(a){function b(b,c){for(var d=0,e=0;c;)d+=a[b]<<e,e+=8,b++,c--;return d}if(1!=b(20,2))throw"Invalid compression code, not PCM";if(1!=b(22,2))throw"Invalid number of channels, not 1";return{sampleRate:b(24,4),bitsPerSample:b(34,2),samples:a.subarray(44)}}function h(a){for(var b=new Float32Array(a.length),c=0;c<a.length;c++){var d=a[c<<1]+(a[(c<<1)+1]<<8);d>=32768&&(d|=-32768),b[c]=d/32768}return b}function i(b){var c=new FileReader;c.onload=function(b){var c=new FormData,d=encodeURIComponent("audio_recording_"+(new Date).getTime()+".mp3");console.log("mp3name = "+d),c.append("fname",d),c.append("data",b.target.result),a.ajax({type:"POST",url:"upload.php",data:c,processData:!1,contentType:!1}).done(function(a){log.innerHTML+="\n"+a})},c.readAsDataURL(b)}var j=e||{},k=j.bufferLen||4096,l=j.numChannels||2;this.context=b.context,this.node=(this.context.createScriptProcessor||this.context.createJavaScriptNode).call(this.context,k,l,l);var m=new Worker(j.workerPath||c);m.postMessage({command:"init",config:{sampleRate:this.context.sampleRate,numChannels:l}});var n,o=!1;this.node.onaudioprocess=function(a){if(o){for(var b=[],c=0;l>c;c++)b.push(a.inputBuffer.getChannelData(c));m.postMessage({command:"record",buffer:b})}},this.configure=function(a){for(var b in a)a.hasOwnProperty(b)&&(j[b]=a[b])},this.record=function(){o=!0},this.stop=function(){o=!1},this.clear=function(){m.postMessage({command:"clear"})},this.getBuffer=function(a){n=a||j.callback,m.postMessage({command:"getBuffer"})},this.exportWAV=function(a,b){if(n=a||j.callback,b=b||j.type||"audio/wav",!n)throw new Error("Callback not set");m.postMessage({command:"exportWAV",type:b})},m.onmessage=function(a){var b,c=a.data,e=new FileReader;e.onload=function(){b=this.result;var a=new Uint8Array(b),c=g(a);console.log(c),console.log("Converting to Mp3"),log.innerHTML+="\nConverting to Mp3",d.postMessage({cmd:"init",config:{mode:3,channels:1,samplerate:c.sampleRate,bitrate:c.bitsPerSample}}),d.postMessage({cmd:"encode",buf:h(c.samples)}),d.postMessage({cmd:"finish"}),d.onmessage=function(a){if("data"==a.data.cmd){console.log("Done converting to Mp3"),log.innerHTML+="\nDone converting to Mp3";var b=new Blob([new Uint8Array(a.data.buf)],{type:"audio/mp3"});i(b);var c="data:audio/mp3;base64,"+f(a.data.buf),d=document.createElement("li"),e=document.createElement("audio"),g=document.createElement("a");e.controls=!0,e.src=c,g.href=c,g.download="audio_recording_"+(new Date).getTime()+".mp3",g.innerHTML=g.download,d.appendChild(e),d.appendChild(g),recordingslist.appendChild(d)}}},e.readAsArrayBuffer(c),n(c)},b.connect(this.node),this.node.connect(this.context.destination)};b.Recorder=e}};return b});